<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>LAGO Simple Chart v5</title>
    <script src="https://unpkg.com/lightweight-charts@5.0.8/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        html, body, #chart { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            background: #FFFFFF;
        }
        #chart { 
            position: relative; 
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    
    <script>
        // LightWeight Charts v5.0.8 ê¸°ì¤€ ê°„ë‹¨í•œ ì°¨íŠ¸ ì‹œìŠ¤í…œ
        let chart = null;
        let mainSeries = null;
        let volumeSeries = null;
        let indicators = {}; // ì§€í‘œ ì‹œë¦¬ì¦ˆ ì €ìž¥
        
        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            console.log('ðŸš€ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œìž‘');
            
            const chartElement = document.getElementById('chart');
            
            // ì°¨íŠ¸ ìƒì„±
            chart = LightweightCharts.createChart(chartElement, {
                layout: {
                    background: { type: 'solid', color: '#FFFFFF' },
                    textColor: '#333333',
                },
                grid: {
                    vertLines: { color: '#f0f0f0' },
                    horzLines: { color: '#f0f0f0' },
                },
                rightPriceScale: {
                    borderVisible: false,
                },
                timeScale: {
                    borderVisible: false,
                    rightOffset: 2,
                    rightBarStaysOnScroll: true,
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
            });
            
            // ë©”ì¸ ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ
            mainSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
            });
            
            // ê±°ëž˜ëŸ‰ ì‹œë¦¬ì¦ˆ (ë³„ë„ íŒ¨ë„)
            volumeSeries = chart.addHistogramSeries({
                color: '#26a69a',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '', // ë³„ë„ ìŠ¤ì¼€ì¼
            });
            
            // ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
            window.addEventListener('resize', () => {
                chart.applyOptions({ 
                    width: chartElement.clientWidth,
                    height: chartElement.clientHeight 
                });
            });
            
            console.log('âœ… ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
            
            // Androidì— ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
            if (window.SimpleChartBridge) {
                window.SimpleChartBridge.onChartReady();
            }
        }
        
        // ë©”ì¸ ìº”ë“¤ ë°ì´í„° ì„¤ì •
        window.setMainData = function(candlesData) {
            try {
                const candles = typeof candlesData === 'string' ? JSON.parse(candlesData) : candlesData;
                console.log('ðŸ“Š ë©”ì¸ ë°ì´í„° ì„¤ì •:', candles.length, 'ê°œ');
                
                if (mainSeries && candles.length > 0) {
                    mainSeries.setData(candles);
                    console.log('âœ… ìº”ë“¤ ë°ì´í„° ì„¤ì • ì™„ë£Œ');
                }
            } catch (e) {
                console.error('âŒ ìº”ë“¤ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', e);
            }
        };
        
        // ê±°ëž˜ëŸ‰ ë°ì´í„° ì„¤ì •
        window.setVolumeData = function(volumeData) {
            try {
                const volumes = typeof volumeData === 'string' ? JSON.parse(volumeData) : volumeData;
                console.log('ðŸ“Š ê±°ëž˜ëŸ‰ ë°ì´í„° ì„¤ì •:', volumes.length, 'ê°œ');
                
                if (volumeSeries && volumes.length > 0) {
                    volumeSeries.setData(volumes);
                    console.log('âœ… ê±°ëž˜ëŸ‰ ë°ì´í„° ì„¤ì • ì™„ë£Œ');
                }
            } catch (e) {
                console.error('âŒ ê±°ëž˜ëŸ‰ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', e);
            }
        };
        
        // ì§€í‘œ ë°ì´í„° ì„¤ì •
        window.setIndicatorData = function(indicatorType, lineData) {
            try {
                const data = typeof lineData === 'string' ? JSON.parse(lineData) : lineData;
                console.log('ðŸ“ˆ ì§€í‘œ ë°ì´í„° ì„¤ì •:', indicatorType, data.length, 'ê°œ');
                
                if (!indicators[indicatorType]) {
                    // ì§€í‘œ ì‹œë¦¬ì¦ˆ ìƒì„±
                    if (indicatorType === 'sma5') {
                        indicators[indicatorType] = chart.addLineSeries({
                            color: '#2196F3',
                            lineWidth: 2,
                            title: 'SMA5',
                        });
                    } else if (indicatorType === 'sma20') {
                        indicators[indicatorType] = chart.addLineSeries({
                            color: '#FF9800',
                            lineWidth: 2,
                            title: 'SMA20',
                        });
                    } else if (indicatorType === 'rsi') {
                        // RSIëŠ” ë³„ë„ íŒ¨ë„ì— ìƒì„±
                        indicators[indicatorType] = chart.addLineSeries({
                            color: '#9C27B0',
                            lineWidth: 2,
                            title: 'RSI',
                            priceScaleId: 'rsi',
                        });
                    }
                }
                
                if (indicators[indicatorType] && data.length > 0) {
                    indicators[indicatorType].setData(data);
                    console.log('âœ…', indicatorType, 'ë°ì´í„° ì„¤ì • ì™„ë£Œ');
                }
                
            } catch (e) {
                console.error('âŒ ì§€í‘œ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', indicatorType, e);
            }
        };
        
        // ì‹¤ì‹œê°„ ìº”ë“¤ ì—…ë°ì´íŠ¸
        window.updateCandle = function(candleData) {
            try {
                const candle = typeof candleData === 'string' ? JSON.parse(candleData) : candleData;
                if (mainSeries) {
                    mainSeries.update(candle);
                }
            } catch (e) {
                console.error('âŒ ìº”ë“¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
            }
        };
        
        // ì‹¤ì‹œê°„ ê±°ëž˜ëŸ‰ ì—…ë°ì´íŠ¸
        window.updateVolume = function(volumeData) {
            try {
                const volume = typeof volumeData === 'string' ? JSON.parse(volumeData) : volumeData;
                if (volumeSeries) {
                    volumeSeries.update(volume);
                }
            } catch (e) {
                console.error('âŒ ê±°ëž˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
            }
        };
        
        // ì§€í‘œ í† ê¸€
        window.toggleIndicator = function(indicatorType, enabled) {
            try {
                console.log('ðŸ”„ ì§€í‘œ í† ê¸€:', indicatorType, enabled);
                
                if (indicators[indicatorType]) {
                    if (enabled) {
                        chart.addSeries(indicators[indicatorType]);
                    } else {
                        chart.removeSeries(indicators[indicatorType]);
                    }
                }
            } catch (e) {
                console.error('âŒ ì§€í‘œ í† ê¸€ ì‹¤íŒ¨:', indicatorType, e);
            }
        };
        
        // íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', initChart);
        
        // ë””ë²„ê¹…ìš©
        window.getChart = () => chart;
        window.getMainSeries = () => mainSeries;
        window.getVolumeSeries = () => volumeSeries;
        window.getIndicators = () => indicators;
        
    </script>
</body>
</html>