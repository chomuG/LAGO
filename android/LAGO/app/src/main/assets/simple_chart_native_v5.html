<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>LAGO Native v5 Chart</title>
    <script src="https://unpkg.com/lightweight-charts@5.0.8/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        html, body, #chart { 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            background: #FFFFFF;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    
    <script>
        // LightWeight Charts v5 ë„¤ì´í‹°ë¸Œ API ì§ì ‘ ì‚¬ìš©
        let chart = null;
        let mainSeries = null; // ìº”ë“¤ìŠ¤í‹±
        let volumeSeries = null; // ê±°ëž˜ëŸ‰
        let sma5Series = null;
        let sma20Series = null;
        let rsiPane = null;
        let rsiSeries = null;
        
        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            console.log('ðŸš€ v5 ë„¤ì´í‹°ë¸Œ ì°¨íŠ¸ ì´ˆê¸°í™”');
            
            const chartElement = document.getElementById('chart');
            
            // ë©”ì¸ ì°¨íŠ¸ ìƒì„±
            chart = LightweightCharts.createChart(chartElement, {
                layout: { 
                    background: { type: 'solid', color: '#ffffff' }, 
                    textColor: '#333' 
                },
                width: chartElement.clientWidth,
                height: chartElement.clientHeight,
                timeScale: { 
                    timeVisible: true, 
                    secondsVisible: false,
                    rightOffset: 2,
                    rightBarStaysOnScroll: true,
                },
                rightPriceScale: { borderVisible: false },
                grid: {
                    vertLines: { color: '#f0f0f0' },
                    horzLines: { color: '#f0f0f0' },
                },
            });
            
            // 1. ë©”ì¸ ìº”ë“¤ìŠ¤í‹± ì‹œë¦¬ì¦ˆ
            mainSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350',
                priceFormat: { type: 'price', precision: 0, minMove: 1 },
            });
            
            // 2. ê±°ëž˜ëŸ‰ ížˆìŠ¤í† ê·¸ëž¨ (ë©”ì¸ íŒ¨ë„)
            volumeSeries = chart.addSeries(LightweightCharts.HistogramSeries, {
                priceFormat: { type: 'volume' },
                priceScaleId: '', // ë³„ë„ ìŠ¤ì¼€ì¼
            });
            
            // 3. SMA5 ë¼ì¸ (ë©”ì¸ íŒ¨ë„ ì˜¤ë²„ë ˆì´)
            sma5Series = chart.addSeries(LightweightCharts.LineSeries, {
                color: '#2196F3',
                lineWidth: 2,
                title: 'SMA5',
            });
            
            // 4. SMA20 ë¼ì¸ (ë©”ì¸ íŒ¨ë„ ì˜¤ë²„ë ˆì´)
            sma20Series = chart.addSeries(LightweightCharts.LineSeries, {
                color: '#FF9800',
                lineWidth: 2,
                title: 'SMA20',
            });
            
            // ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
            window.addEventListener('resize', () => {
                chart.applyOptions({ 
                    width: chartElement.clientWidth,
                    height: chartElement.clientHeight 
                });
            });
            
            console.log('âœ… v5 ë„¤ì´í‹°ë¸Œ ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
            
            // Androidì— ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
            if (window.NativeChartBridge) {
                window.NativeChartBridge.onChartReady();
            }
        }
        
        // ========== ê°„ë‹¨í•œ v5 ë„¤ì´í‹°ë¸Œ API ==========
        
        // ìº”ë“¤ ë°ì´í„° ì„¤ì • (UTCTimestamp ì´ˆ ë‹¨ìœ„)
        window.setCandleData = function(candlesJson) {
            try {
                const candles = typeof candlesJson === 'string' ? JSON.parse(candlesJson) : candlesJson;
                console.log('ðŸ“Š ìº”ë“¤ ë°ì´í„° ì„¤ì •:', candles.length, 'ê°œ');
                
                if (mainSeries && candles.length > 0) {
                    mainSeries.setData(candles);
                    chart.timeScale().fitContent();
                    console.log('âœ… ìº”ë“¤ setData ì™„ë£Œ');
                }
            } catch (e) {
                console.error('âŒ ìº”ë“¤ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', e);
            }
        };
        
        // ê±°ëž˜ëŸ‰ ë°ì´í„° ì„¤ì •
        window.setVolumeData = function(volumesJson) {
            try {
                const volumes = typeof volumesJson === 'string' ? JSON.parse(volumesJson) : volumesJson;
                console.log('ðŸ“Š ê±°ëž˜ëŸ‰ ë°ì´í„° ì„¤ì •:', volumes.length, 'ê°œ');
                
                if (volumeSeries && volumes.length > 0) {
                    volumeSeries.setData(volumes);
                    console.log('âœ… ê±°ëž˜ëŸ‰ setData ì™„ë£Œ');
                }
            } catch (e) {
                console.error('âŒ ê±°ëž˜ëŸ‰ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', e);
            }
        };
        
        // SMA5 ë°ì´í„° ì„¤ì •
        window.setSMA5Data = function(smaJson) {
            try {
                const smaData = typeof smaJson === 'string' ? JSON.parse(smaJson) : smaJson;
                console.log('ðŸ“ˆ SMA5 ë°ì´í„° ì„¤ì •:', smaData.length, 'ê°œ');
                
                if (sma5Series && smaData.length > 0) {
                    sma5Series.setData(smaData);
                    console.log('âœ… SMA5 setData ì™„ë£Œ');
                }
            } catch (e) {
                console.error('âŒ SMA5 ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', e);
            }
        };
        
        // SMA20 ë°ì´í„° ì„¤ì •
        window.setSMA20Data = function(smaJson) {
            try {
                const smaData = typeof smaJson === 'string' ? JSON.parse(smaJson) : smaJson;
                console.log('ðŸ“ˆ SMA20 ë°ì´í„° ì„¤ì •:', smaData.length, 'ê°œ');
                
                if (sma20Series && smaData.length > 0) {
                    sma20Series.setData(smaData);
                    console.log('âœ… SMA20 setData ì™„ë£Œ');
                }
            } catch (e) {
                console.error('âŒ SMA20 ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', e);
            }
        };
        
        // RSI íŒ¨ë„ ìƒì„± ë° ë°ì´í„° ì„¤ì •
        window.setRSIData = function(rsiJson) {
            try {
                const rsiData = typeof rsiJson === 'string' ? JSON.parse(rsiJson) : rsiJson;
                console.log('ðŸ“Š RSI ë°ì´í„° ì„¤ì •:', rsiData.length, 'ê°œ');
                
                // RSI íŒ¨ë„ì´ ì—†ìœ¼ë©´ ìƒì„±
                if (!rsiPane) {
                    rsiPane = chart.addPane(true); // ìƒˆ íŒ¨ë„ ì¶”ê°€
                    rsiSeries = rsiPane.addSeries(LightweightCharts.LineSeries, {
                        color: '#9C27B0',
                        lineWidth: 2,
                        title: 'RSI',
                    });
                    console.log('ðŸ“Š RSI íŒ¨ë„ ìƒì„± ì™„ë£Œ');
                }
                
                if (rsiSeries && rsiData.length > 0) {
                    rsiSeries.setData(rsiData);
                    console.log('âœ… RSI setData ì™„ë£Œ');
                }
            } catch (e) {
                console.error('âŒ RSI ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', e);
            }
        };
        
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        window.updateCandle = function(candleJson) {
            try {
                const candle = typeof candleJson === 'string' ? JSON.parse(candleJson) : candleJson;
                if (mainSeries) {
                    mainSeries.update(candle);
                }
            } catch (e) {
                console.error('âŒ ìº”ë“¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
            }
        };
        
        window.updateVolume = function(volumeJson) {
            try {
                const volume = typeof volumeJson === 'string' ? JSON.parse(volumeJson) : volumeJson;
                if (volumeSeries) {
                    volumeSeries.update(volume);
                }
            } catch (e) {
                console.error('âŒ ê±°ëž˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', e);
            }
        };
        
        // ì§€í‘œ í† ê¸€ (show/hide)
        window.toggleSMA5 = function(visible) {
            if (sma5Series) {
                sma5Series.applyOptions({ visible: visible });
                console.log('ðŸ”„ SMA5 í† ê¸€:', visible);
            }
        };
        
        window.toggleSMA20 = function(visible) {
            if (sma20Series) {
                sma20Series.applyOptions({ visible: visible });
                console.log('ðŸ”„ SMA20 í† ê¸€:', visible);
            }
        };
        
        window.toggleVolume = function(visible) {
            if (volumeSeries) {
                volumeSeries.applyOptions({ visible: visible });
                console.log('ðŸ”„ ê±°ëž˜ëŸ‰ í† ê¸€:', visible);
            }
        };
        
        window.toggleRSI = function(visible) {
            if (rsiSeries) {
                rsiSeries.applyOptions({ visible: visible });
                console.log('ðŸ”„ RSI í† ê¸€:', visible);
            }
        };
        
        // ëª¨ë“  ë°ì´í„° í•œë²ˆì— ì„¤ì • (ì´ˆê¸° ë¡œë”©ìš©)
        window.setAllData = function(candlesJson, volumesJson, sma5Json, sma20Json, rsiJson) {
            console.log('ðŸš€ ëª¨ë“  ë°ì´í„° í•œë²ˆì— ì„¤ì •');
            
            if (candlesJson) window.setCandleData(candlesJson);
            if (volumesJson) window.setVolumeData(volumesJson);
            if (sma5Json) window.setSMA5Data(sma5Json);
            if (sma20Json) window.setSMA20Data(sma20Json);
            if (rsiJson) window.setRSIData(rsiJson);
            
            console.log('âœ… ëª¨ë“  ë°ì´í„° ì„¤ì • ì™„ë£Œ');
        };
        
        // íŽ˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', initChart);
        
        // ë””ë²„ê¹…ìš©
        window.getChart = () => chart;
        window.getMainSeries = () => mainSeries;
        
    </script>
</body>
</html>