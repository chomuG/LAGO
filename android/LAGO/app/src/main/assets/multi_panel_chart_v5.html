<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>LAGO Multi Panel Chart v5</title>
<script src="https://unpkg.com/lightweight-charts@5.0.8/dist/lightweight-charts.standalone.production.js"></script>
<style>
html,body,#root{height:100%;margin:0;padding:0;background:#FFFFFF;color:#333;font-family:sans-serif}
#root{position:relative}
#chart{position:absolute;inset:0}
</style>
</head>
<body>
<div id="root"><div id="chart"></div></div>
<script>
let __chart = null;
let __mainSeries = null;
let __volumeSeries = null;
let __followRT = true;

let __resizeObserver = null;
let __orientationHandler = null;
let __visibilityHandler = null;

// ğŸ”¥ ì°¨íŠ¸ ìƒíƒœ ê´€ë¦¬ ë° ìˆœì°¨ ë¡œë”©ì„ ìœ„í•œ ë³€ìˆ˜ë“¤
let __chartReady = false;
let __dataLoaded = false;
let __indicatorsApplied = false;
let __pendingDataQueue = [];
let __pendingIndicatorQueue = [];
let __loadingStage = 'INITIALIZING'; // INITIALIZING -> CHART_READY -> DATA_LOADED -> INDICATORS_APPLIED -> COMPLETED

function initChart() {
  console.log('[HTML] ğŸ”¥ ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');
  __loadingStage = 'INITIALIZING';
  updateLoadingProgress(10, 'Initializing chart...');

  // Cleanup previous instances
  if (__resizeObserver) {
    __resizeObserver.disconnect();
    __resizeObserver = null;
  }
  if (__orientationHandler) {
    window.removeEventListener('orientationchange', __orientationHandler);
    __orientationHandler = null;
  }
  if (__visibilityHandler) {
    document.removeEventListener('visibilitychange', __visibilityHandler);
    __visibilityHandler = null;
  }
  if (__chart) {
    try { __chart.remove(); } catch(e) { console.error('Chart remove error:', e); }
    __chart = null;
  }

  // ğŸ”¥ ìƒíƒœ ì´ˆê¸°í™”
  __chartReady = false;
  __dataLoaded = false;
  __indicatorsApplied = false;
  __pendingDataQueue = [];
  __pendingIndicatorQueue = [];

  const el = document.getElementById('chart');
  const cw = Math.max(1, Math.floor(el.clientWidth));
  const ch = Math.max(1, Math.floor(el.clientHeight));
  
  updateLoadingProgress(30, 'Creating chart instance...');
  
  __chart = LightweightCharts.createChart(el, {
    autoSize: false,
    width: cw,
    height: ch,
    layout:{ background:{ type:'Solid', color:'#FFFFFF' }, textColor:'#333333' },
    rightPriceScale:{ borderVisible:false },
    timeScale:{ rightOffset:2, rightBarStaysOnScroll:true, borderVisible:false }
  });
  __mainSeries = __chart.addCandlestickSeries();
  __volumeSeries = __chart.addHistogramSeries({ priceFormat: { type: 'volume' }, priceScaleId:''});

  updateLoadingProgress(50, 'Setting up chart interactions...');

  const ts = __chart.timeScale();
  ts.subscribeVisibleLogicalRangeChange(() => {
    const range = ts.getVisibleLogicalRange();
    if (!range) return;
    const info = __mainSeries.barsInLogicalRange(range) || {};
    __followRT = (info.barsAfter ?? 0) < 1;
    if ((info.barsBefore ?? 0) < 20 && window.Android && Android.onRequestHistoricalData) {
      Android.onRequestHistoricalData(200);
    }
  });

  // Setup ResizeObserver
  __resizeObserver = new ResizeObserver(entries => {
    for (const entry of entries) {
      const cr = entry.contentRect;
      const w = Math.max(1, Math.floor(cr.width));
      const h = Math.max(1, Math.floor(cr.height));
      if (__chart) {
        __chart.applyOptions({ width: w, height: h });
        console.log('[HTML] Chart resized to:', w + 'x' + h);
      }
    }
  });
  __resizeObserver.observe(el);

  // Orientation change handler
  __orientationHandler = () => {
    setTimeout(() => {
      const b = el.getBoundingClientRect();
      const w = Math.max(1, Math.floor(b.width));
      const h = Math.max(1, Math.floor(b.height));
      if (__chart) {
        __chart.applyOptions({ width: w, height: h });
        console.log('[HTML] (orientation) resized to:', w + 'x' + h);
      }
    }, 200);
  };
  window.addEventListener('orientationchange', __orientationHandler);

  // Visibility change handler
  __visibilityHandler = () => {
    if (document.visibilityState === 'visible' && __chart) {
      const b = el.getBoundingClientRect();
      const w = Math.max(1, Math.floor(b.width));
      const h = Math.max(1, Math.floor(b.height));
      __chart.applyOptions({ width: w, height: h });
      console.log('[HTML] (visible) resized to:', w + 'x' + h);
    }
  };
  document.addEventListener('visibilitychange', __visibilityHandler);

  // ğŸ”¥ ì°¨íŠ¸ ì¤€ë¹„ ì™„ë£Œ - ìˆœì°¨ì  ë¡œë”© ì‹œì‘
  updateLoadingProgress(70, 'Chart ready, processing data queue...');
  __chartReady = true;
  __loadingStage = 'CHART_READY';
  console.log('[HTML] âœ… ì°¨íŠ¸ ì¤€ë¹„ ì™„ë£Œ');

  // ëŒ€ê¸° ì¤‘ì¸ ë°ì´í„° ì²˜ë¦¬
  processPendingData();

  // Chart ready callbacks
  try { 
    if (window.ChartBridge && ChartBridge.onChartReady) {
      console.log('[HTML] ğŸ“ ChartBridge.onChartReady() í˜¸ì¶œ');
      ChartBridge.onChartReady();
    }
    if (window.Android && Android.onChartReady) {
      console.log('[HTML] ğŸ“ Android.onChartReady() í˜¸ì¶œ');
      Android.onChartReady();
    }
    if (window.ChartInterface && ChartInterface.onChartReady) {
      console.log('[HTML] ğŸ“ ChartInterface.onChartReady() í˜¸ì¶œ');
      ChartInterface.onChartReady();
    }
  } catch(e) {
    console.error('[HTML] âŒ Chart ready ì½œë°± í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:', e);
  }
}

// ğŸ”¥ ìƒˆë¡œìš´ setInitialData - MultiPanelChart.ktì™€ í˜¸í™˜
window.setInitialData = function(seriesId, jsonArray) {
  console.log('[HTML] ğŸ“Š setInitialData í˜¸ì¶œ - seriesId:', seriesId);
  
  try {
    const candles = JSON.parse(jsonArray);
    console.log('[HTML] ğŸ“Š ìº”ë“¤ ë°ì´í„° íŒŒì‹± ì™„ë£Œ:', candles.length + 'ê°œ');
    
    if (seriesId === 'candle' || !seriesId) {
      // ìº”ë“¤ìŠ¤í‹± ë°ì´í„° ì„¤ì •
      if (__mainSeries) {
        __mainSeries.setData(candles);
        console.log('[HTML] âœ… ìº”ë“¤ìŠ¤í‹± ë°ì´í„° ì„¤ì • ì™„ë£Œ');
        
        // ğŸ”¥ ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬
        __dataLoaded = true;
        __loadingStage = 'DATA_LOADED';
        
        // íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ê°•ì œ ì™„ë£Œ
        setTimeout(() => {
          if (!__indicatorsApplied) {
            console.log('[HTML] â° ê°•ì œ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬');
            __indicatorsApplied = true;
            completeLoading();
          }
        }, 500); // 0.5ì´ˆ í›„ ê°•ì œ ì™„ë£Œ
        
        __chart.timeScale().fitContent();
      } else {
        console.error('[HTML] âŒ __mainSeriesê°€ ì—†ìŒ');
      }
    } else if (seriesId === 'volume') {
      // ê±°ë˜ëŸ‰ ë°ì´í„° ì„¤ì •
      if (__volumeSeries) {
        __volumeSeries.setData(candles); // ê±°ë˜ëŸ‰ë„ ê°™ì€ í˜•ì‹
        console.log('[HTML] âœ… ê±°ë˜ëŸ‰ ë°ì´í„° ì„¤ì • ì™„ë£Œ');
      } else {
        console.error('[HTML] âŒ __volumeSeriesê°€ ì—†ìŒ');
      }
    } else {
      console.warn('[HTML] âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” seriesId:', seriesId);
    }
    
  } catch (e) {
    console.error('[HTML] âŒ setInitialData ì˜¤ë¥˜:', e);
  }
};

// ğŸ”¥ ê¸°ì¡´ í˜¸í™˜ì„±ì„ ìœ„í•œ setInitialData (candlesJson, volumesJson)
function setInitialDataLegacy(candlesJson, volumesJson) {
  console.log('[HTML] ğŸ“Š ë ˆê±°ì‹œ ì´ˆê¸° ë°ì´í„° ì„¤ì • ìš”ì²­');
  
  if (!__chartReady) {
    console.log('[HTML] â³ ì°¨íŠ¸ ì¤€ë¹„ ì „ - ë°ì´í„° íì— ì¶”ê°€');
    __pendingDataQueue.push({ type: 'initial', candlesJson, volumesJson });
    return;
  }

  try {
    updateLoadingProgress(80, 'Loading chart data...');
    const candles = JSON.parse(candlesJson);
    const volumes = volumesJson ? JSON.parse(volumesJson) : [];
    
    __mainSeries.setData(candles);
    if (volumes && volumes.length) __volumeSeries.setData(volumes);
    
    __dataLoaded = true;
    __loadingStage = 'DATA_LOADED';
    console.log('[HTML] âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
    
    // ğŸ”¥ ê°•ì œ ì™„ë£Œ ì²˜ë¦¬
    setTimeout(() => {
      if (!__indicatorsApplied) {
        console.log('[HTML] â° íƒ€ì„ì•„ì›ƒ - ê°•ì œ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬');
        __indicatorsApplied = true;
        completeLoading();
      }
    }, 1000); // 1ì´ˆ í›„ ê°•ì œ ì™„ë£Œ
    
    // ëŒ€ê¸° ì¤‘ì¸ ì§€í‘œ ì²˜ë¦¬
    processPendingIndicators();
    
    // ğŸ”¥ ì§€í‘œê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬
    if (__pendingIndicatorQueue.length === 0) {
      console.log('[HTML] ğŸ“ˆ ëŒ€ê¸° ì¤‘ì¸ ì§€í‘œê°€ ì—†ìŒ - ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬');
      setTimeout(() => {
        __indicatorsApplied = true;
        completeLoading();
      }, 300); // 0.3ì´ˆ í›„ ì™„ë£Œ
    }
  } catch (e) {
    console.error('LAGO setInitialDataLegacy error', e);
    updateLoadingProgress(0, 'Data loading failed');
  }
}

function prependHistoricalData(candlesJson, volumesJson) {
  try {
    const candles = JSON.parse(candlesJson);
    const prev = __mainSeries._data?._series?._items || [];
    __mainSeries.setData(candles.concat(prev));
    if (volumesJson) {
      const vols = JSON.parse(volumesJson);
      const vprev = __volumeSeries._data?._series?._items || [];
      __volumeSeries.setData(vols.concat(vprev));
    }
  } catch (e) { console.error('prependHistoricalData error', e); }
}

function updateBar(bar) {
  __mainSeries.update(bar);
  if (__followRT) __chart.timeScale().scrollToRealTime();
}
function updateVolume(vol) { __volumeSeries.update(vol); }

function setTimeFrame(tf) { /* hook */ }

function setIndicatorEnabled(type, enabled, payloadJson) {
  console.log('[HTML] ğŸ“ˆ ì§€í‘œ ì„¤ì • ìš”ì²­:', type, enabled);
  
  if (!__dataLoaded) {
    console.log('[HTML] â³ ë°ì´í„° ë¡œë“œ ì „ - ì§€í‘œ íì— ì¶”ê°€');
    __pendingIndicatorQueue.push({ type, enabled, payloadJson });
    return;
  }

  try {
    updateLoadingProgress(90, `Applying ${type} indicator...`);
    // implement with your pane/series manager
    console.log('[HTML] âœ… ì§€í‘œ ì ìš© ì™„ë£Œ:', type);
    
    // ëª¨ë“  ì§€í‘œ ì ìš© ì™„ë£Œ í™•ì¸
    if (__pendingIndicatorQueue.length === 0) {
      __indicatorsApplied = true;
      __loadingStage = 'INDICATORS_APPLIED';
      completeLoading();
    }
  } catch (e) {
    console.error('Indicator setup error:', e);
  }
}

function setTradeMarkers(markersJson) {
  try {
    const markers = JSON.parse(markersJson);
    __mainSeries.setMarkers(markers);
  } catch(e){ console.error('markers error', e); }
}
function clearTradeMarkers(){ __mainSeries.setMarkers([]); }

function setAutoPatternAnalysis(enabled) {
  if (!__chart || !__chart.timeScale) return;
  const ts = __chart.timeScale();
  if (enabled) {
    ts.subscribeVisibleTimeRangeChange((range) => {
      if (!range) return;
      const from = Math.floor(range.from);
      const to = Math.floor(range.to);
      if (window.ChartBridge && ChartBridge.analyzePatternInRange) {
        ChartBridge.analyzePatternInRange(String(from), String(to));
      }
    });
  }
}

// ğŸ”¥ ìˆœì°¨ì  ë¡œë”©ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜ë“¤
function updateLoadingProgress(percentage, message) {
  console.log(`[HTML] ğŸ“Š Loading: ${percentage}% - ${message}`);
  try {
    if (window.ChartBridge && ChartBridge.onLoadingProgress) {
      console.log(`[HTML] ğŸ“ ChartBridge.onLoadingProgress(${percentage}) í˜¸ì¶œ`);
      ChartBridge.onLoadingProgress(percentage);
    }
    if (window.Android && Android.onLoadingProgress) {
      console.log(`[HTML] ğŸ“ Android.onLoadingProgress(${percentage}) í˜¸ì¶œ`);
      Android.onLoadingProgress(percentage);
    }
    if (window.ChartInterface && ChartInterface.onLoadingProgress) {
      console.log(`[HTML] ğŸ“ ChartInterface.onLoadingProgress(${percentage}) í˜¸ì¶œ`);
      ChartInterface.onLoadingProgress(percentage);
    }
  } catch(e) {
    console.error('[HTML] âŒ Loading progress ì½œë°± í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:', e);
  }
}

function processPendingData() {
  if (__pendingDataQueue.length > 0) {
    console.log('[HTML] ğŸ”„ ëŒ€ê¸° ì¤‘ì¸ ë°ì´í„° ì²˜ë¦¬:', __pendingDataQueue.length);
    const dataItem = __pendingDataQueue.shift();
    if (dataItem.type === 'initial') {
      setInitialData(dataItem.candlesJson, dataItem.volumesJson);
    }
  } else if (__dataLoaded) {
    // ë°ì´í„°ê°€ ì´ë¯¸ ë¡œë“œë˜ì—ˆê³  ëŒ€ê¸° ì¤‘ì¸ ì§€í‘œê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
    processPendingIndicators();
  }
}

function processPendingIndicators() {
  if (__pendingIndicatorQueue.length > 0) {
    console.log('[HTML] ğŸ”„ ëŒ€ê¸° ì¤‘ì¸ ì§€í‘œ ì²˜ë¦¬:', __pendingIndicatorQueue.length);
    const indicatorItem = __pendingIndicatorQueue.shift();
    setIndicatorEnabled(indicatorItem.type, indicatorItem.enabled, indicatorItem.payloadJson);
  } else {
    // ëª¨ë“  ì§€í‘œ ì²˜ë¦¬ ì™„ë£Œ
    __indicatorsApplied = true;
    __loadingStage = 'INDICATORS_APPLIED';
    completeLoading();
  }
}

function completeLoading() {
  console.log('[HTML] ğŸ” completeLoading í˜¸ì¶œ - ìƒíƒœ í™•ì¸');
  console.log('[HTML] ğŸ“Š __chartReady:', __chartReady, '__dataLoaded:', __dataLoaded, '__indicatorsApplied:', __indicatorsApplied);
  
  if (__chartReady && __dataLoaded) {
    // ğŸ”¥ ì§€í‘œ ì ìš© ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë°ì´í„°ê°€ ë¡œë“œë˜ë©´ ì™„ë£Œ ì²˜ë¦¬
    __loadingStage = 'COMPLETED';
    __indicatorsApplied = true; // ê°•ì œë¡œ ì™„ë£Œ ìƒíƒœë¡œ ì„¤ì •
    
    // ğŸ”¥ ì°¨íŠ¸ ë°ì´í„° ìµœì¢… ê²€ì¦ ë° ë³µêµ¬
    validateAndRepairChart();
    
    updateLoadingProgress(100, 'Chart loading completed');
    console.log('[HTML] ğŸ‰ ì°¨íŠ¸ ë¡œë”© ì™„ì „ ì™„ë£Œ!');
    
    // ì™„ë£Œ ì½œë°± í˜¸ì¶œ
    try {
      if (window.ChartBridge && ChartBridge.onChartLoadingCompleted) {
        console.log('[HTML] ğŸ“ ChartBridge.onChartLoadingCompleted() í˜¸ì¶œ');
        ChartBridge.onChartLoadingCompleted();
      }
      if (window.Android && Android.onChartLoadingCompleted) {
        console.log('[HTML] ğŸ“ Android.onChartLoadingCompleted() í˜¸ì¶œ');
        Android.onChartLoadingCompleted();
      }
      if (window.ChartInterface && ChartInterface.onChartLoadingCompleted) {
        console.log('[HTML] ğŸ“ ChartInterface.onChartLoadingCompleted() í˜¸ì¶œ');
        ChartInterface.onChartLoadingCompleted();
      }
    } catch(e) {
      console.error('[HTML] âŒ ì™„ë£Œ ì½œë°± í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜:', e);
    }
  } else {
    console.warn('[HTML] âš ï¸ ë¡œë”© ì™„ë£Œ ì¡°ê±´ ë¯¸ì¶©ì¡± - chartReady:', __chartReady, 'dataLoaded:', __dataLoaded);
  }
}

// ğŸ”¥ ì°¨íŠ¸ ë°ì´í„° ê²€ì¦ ë° ë³µêµ¬ í•¨ìˆ˜
function validateAndRepairChart() {
  try {
    console.log('[HTML] ğŸ” ì°¨íŠ¸ ë°ì´í„° ìµœì¢… ê²€ì¦ ì‹œì‘');
    
    if (!__chart || !__mainSeries) {
      console.error('[HTML] âŒ ì°¨íŠ¸ë‚˜ ìº”ë“¤ ì‹œë¦¬ì¦ˆê°€ ì—†ìŒ');
      return;
    }
    
    // ìº”ë“¤ìŠ¤í‹± ë°ì´í„° ê²€ì¦
    const candleData = __mainSeries.data();
    console.log('[HTML] ğŸ“Š ìº”ë“¤ìŠ¤í‹± ë°ì´í„° ê°œìˆ˜:', candleData.length);
    
    if (candleData.length === 0) {
      console.error('[HTML] âŒ ìº”ë“¤ìŠ¤í‹± ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ - ë³µêµ¬ ì‹œë„');
      
      // ëŒ€ê¸° ì¤‘ì¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ì‹œë„
      if (__pendingDataQueue.length > 0) {
        console.log('[HTML] ğŸ”„ ëŒ€ê¸° ì¤‘ì¸ ë°ì´í„°ë¡œ ë³µêµ¬ ì‹œë„');
        processPendingData();
        return;
      }
    }
    
    // ê±°ë˜ëŸ‰ ë°ì´í„° ê²€ì¦
    if (__volumeSeries) {
      const volumeData = __volumeSeries.data();
      console.log('[HTML] ğŸ“Š ê±°ë˜ëŸ‰ ë°ì´í„° ê°œìˆ˜:', volumeData.length);
      
      if (volumeData.length === 0 && candleData.length > 0) {
        console.warn('[HTML] âš ï¸ ê±°ë˜ëŸ‰ ë°ì´í„°ê°€ ì—†ìŒ - ê¸°ë³¸ ê±°ë˜ëŸ‰ ìƒì„±');
        
        // ìº”ë“¤ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê¸°ë³¸ ê±°ë˜ëŸ‰ ìƒì„±
        const defaultVolumeData = candleData.map(candle => ({
          time: candle.time,
          value: Math.random() * 1000000 + 100000, // ê¸°ë³¸ ê±°ë˜ëŸ‰
          color: candle.close >= candle.open ? '#26a69a' : '#ef5350'
        }));
        
        __volumeSeries.setData(defaultVolumeData);
        console.log('[HTML] âœ… ê¸°ë³¸ ê±°ë˜ëŸ‰ ë°ì´í„° ìƒì„± ì™„ë£Œ');
      }
    }
    
    // ì°¨íŠ¸ ê°€ì‹œì„± ê°•ì œ ìƒˆë¡œê³ ì¹¨
    if (__chart) {
      console.log('[HTML] ğŸ”„ ì°¨íŠ¸ ê°•ì œ ìƒˆë¡œê³ ì¹¨');
      __chart.timeScale().fitContent();
      
      // ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ì‹œ ë§ì¶¤
      setTimeout(() => {
        try {
          __chart.timeScale().fitContent();
          console.log('[HTML] âœ… ì°¨íŠ¸ ì‹œê°„ì¶• ë§ì¶¤ ì™„ë£Œ');
        } catch (e) {
          console.warn('[HTML] âš ï¸ ì§€ì—°ëœ ì°¨íŠ¸ ë§ì¶¤ ì‹¤íŒ¨:', e);
        }
      }, 500);
    }
    
    console.log('[HTML] âœ… ì°¨íŠ¸ ë°ì´í„° ê²€ì¦ ì™„ë£Œ');
    
  } catch (e) {
    console.error('[HTML] âŒ validateAndRepairChart ì˜¤ë¥˜:', e);
  }
}

window.beginLoad = function(id){};
window.endLoad = function(id){};

window.requestPatternAnalysis = function() {
  try {
    const r = __chart.timeScale().getVisibleRange();
    if (r && window.ChartBridge && ChartBridge.analyzePatternInRange) {
      ChartBridge.analyzePatternInRange(String(Math.floor(r.from)), String(Math.floor(r.to)));
    }
  } catch(e){ console.warn('requestPatternAnalysis failed', e); }
};

// ğŸ”¥ ì‹¤ì‹œê°„ ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
window.updateRealTimeBar = function(barDataJson) {
  try {
    console.log('[HTML] ğŸ“Š ì‹¤ì‹œê°„ ìº”ë“¤ ì—…ë°ì´íŠ¸ ì‹œì‘:', barDataJson);
    
    if (!__chart || !__mainSeries) {
      console.warn('[HTML] âš ï¸ ì°¨íŠ¸ë‚˜ ìº”ë“¤ ì‹œë¦¬ì¦ˆê°€ ì—†ì–´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¶ˆê°€');
      return;
    }
    
    const barData = JSON.parse(barDataJson);
    console.log('[HTML] ğŸ“Š íŒŒì‹±ëœ ìº”ë“¤ ë°ì´í„°:', barData);
    
    // í˜„ì¬ ì°¨íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const existingData = __mainSeries.data();
    console.log('[HTML] ğŸ“Š ê¸°ì¡´ ë°ì´í„° ê°œìˆ˜:', existingData.length);
    
    if (existingData.length === 0) {
      console.warn('[HTML] âš ï¸ ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ì–´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¶ˆê°€');
      return;
    }
    
    // ìƒˆ ë°ì´í„°ì˜ ì‹œê°„
    const newTime = barData.time;
    
    // ë§ˆì§€ë§‰ ê¸°ì¡´ ìº”ë“¤ì˜ ì‹œê°„
    const lastExistingTime = existingData[existingData.length - 1].time;
    
    console.log('[HTML] ğŸ“Š ì‹œê°„ ë¹„êµ - ìƒˆ ë°ì´í„°:', newTime, 'ê¸°ì¡´ ë§ˆì§€ë§‰:', lastExistingTime);
    
    if (newTime === lastExistingTime) {
      // ğŸ”¥ ê°™ì€ ì‹œê°„ëŒ€ - ê¸°ì¡´ ìº”ë“¤ ì—…ë°ì´íŠ¸
      console.log('[HTML] ğŸ”„ ê¸°ì¡´ ìº”ë“¤ ì—…ë°ì´íŠ¸ (ê°™ì€ ì‹œê°„ëŒ€)');
      
      // ê¸°ì¡´ ë°ì´í„°ì˜ ë§ˆì§€ë§‰ ìº”ë“¤ì„ ìƒˆ ë°ì´í„°ë¡œ êµì²´
      const updatedData = [...existingData];
      updatedData[updatedData.length - 1] = {
        time: newTime,
        open: barData.open,
        high: Math.max(updatedData[updatedData.length - 1].high, barData.high),
        low: Math.min(updatedData[updatedData.length - 1].low, barData.low),
        close: barData.close
      };
      
      __mainSeries.setData(updatedData);
      console.log('[HTML] âœ… ê¸°ì¡´ ìº”ë“¤ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      
    } else if (newTime > lastExistingTime) {
      // ğŸ”¥ ìƒˆ ì‹œê°„ëŒ€ - ìƒˆ ìº”ë“¤ ì¶”ê°€
      console.log('[HTML] â• ìƒˆ ìº”ë“¤ ì¶”ê°€ (ìƒˆ ì‹œê°„ëŒ€)');
      
      __mainSeries.update(barData);
      console.log('[HTML] âœ… ìƒˆ ìº”ë“¤ ì¶”ê°€ ì™„ë£Œ');
      
    } else {
      console.warn('[HTML] âš ï¸ ê³¼ê±° ì‹œê°„ ë°ì´í„° ë¬´ì‹œ:', newTime, '<=', lastExistingTime);
    }
    
  } catch (e) {
    console.error('[HTML] âŒ updateRealTimeBar ì˜¤ë¥˜:', e);
  }
};

window.updateRealTimeVolume = function(volumeDataJson) {
  try {
    console.log('[HTML] ğŸ“Š ì‹¤ì‹œê°„ ê±°ë˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹œì‘:', volumeDataJson);
    
    if (!__volumeSeries) {
      console.warn('[HTML] âš ï¸ ê±°ë˜ëŸ‰ ì‹œë¦¬ì¦ˆê°€ ì—†ì–´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¶ˆê°€');
      return;
    }
    
    const volumeData = JSON.parse(volumeDataJson);
    console.log('[HTML] ğŸ“Š íŒŒì‹±ëœ ê±°ë˜ëŸ‰ ë°ì´í„°:', volumeData);
    
    // í˜„ì¬ ê±°ë˜ëŸ‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const existingVolumeData = __volumeSeries.data();
    console.log('[HTML] ğŸ“Š ê¸°ì¡´ ê±°ë˜ëŸ‰ ë°ì´í„° ê°œìˆ˜:', existingVolumeData.length);
    
    if (existingVolumeData.length === 0) {
      console.warn('[HTML] âš ï¸ ê¸°ì¡´ ê±°ë˜ëŸ‰ ë°ì´í„°ê°€ ì—†ì–´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¶ˆê°€');
      return;
    }
    
    // ìƒˆ ë°ì´í„°ì˜ ì‹œê°„
    const newTime = volumeData.time;
    
    // ë§ˆì§€ë§‰ ê¸°ì¡´ ê±°ë˜ëŸ‰ì˜ ì‹œê°„
    const lastExistingTime = existingVolumeData[existingVolumeData.length - 1].time;
    
    console.log('[HTML] ğŸ“Š ê±°ë˜ëŸ‰ ì‹œê°„ ë¹„êµ - ìƒˆ ë°ì´í„°:', newTime, 'ê¸°ì¡´ ë§ˆì§€ë§‰:', lastExistingTime);
    
    if (newTime === lastExistingTime) {
      // ğŸ”¥ ê°™ì€ ì‹œê°„ëŒ€ - ê¸°ì¡´ ê±°ë˜ëŸ‰ ì—…ë°ì´íŠ¸ (ëˆ„ì )
      console.log('[HTML] ğŸ”„ ê¸°ì¡´ ê±°ë˜ëŸ‰ ì—…ë°ì´íŠ¸ (ëˆ„ì )');
      
      const updatedVolumeData = [...existingVolumeData];
      const lastVolume = updatedVolumeData[updatedVolumeData.length - 1];
      
      updatedVolumeData[updatedVolumeData.length - 1] = {
        time: newTime,
        value: lastVolume.value + volumeData.value, // ê±°ë˜ëŸ‰ ëˆ„ì 
        color: volumeData.color
      };
      
      __volumeSeries.setData(updatedVolumeData);
      console.log('[HTML] âœ… ê¸°ì¡´ ê±°ë˜ëŸ‰ ëˆ„ì  ì™„ë£Œ');
      
    } else if (newTime > lastExistingTime) {
      // ğŸ”¥ ìƒˆ ì‹œê°„ëŒ€ - ìƒˆ ê±°ë˜ëŸ‰ ì¶”ê°€
      console.log('[HTML] â• ìƒˆ ê±°ë˜ëŸ‰ ì¶”ê°€ (ìƒˆ ì‹œê°„ëŒ€)');
      
      __volumeSeries.update(volumeData);
      console.log('[HTML] âœ… ìƒˆ ê±°ë˜ëŸ‰ ì¶”ê°€ ì™„ë£Œ');
      
    } else {
      console.warn('[HTML] âš ï¸ ê³¼ê±° ì‹œê°„ ê±°ë˜ëŸ‰ ë°ì´í„° ë¬´ì‹œ:', newTime, '<=', lastExistingTime);
    }
    
  } catch (e) {
    console.error('[HTML] âŒ updateRealTimeVolume ì˜¤ë¥˜:', e);
  }
};

window.addEventListener('load', initChart);
</script>
</body>
</html>