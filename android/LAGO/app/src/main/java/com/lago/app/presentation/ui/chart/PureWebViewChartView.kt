package com.lago.app.presentation.ui.chart

import android.webkit.WebView
import android.webkit.WebViewClient
import android.webkit.WebChromeClient
import androidx.compose.foundation.layout.*
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.viewinterop.AndroidView
import com.lago.app.domain.entity.*

/**
 * ÏàúÏàò WebView Í∏∞Î∞ò v5 Ï∞®Ìä∏ - Android wrapper ÏôÑÏ†Ñ Ïö∞Ìöå
 */
@Composable
fun PureWebViewChartView(
    candlestickData: List<CandlestickData>,
    volumeData: List<VolumeData>,
    sma5Data: List<LineData>,
    sma20Data: List<LineData>,
    config: ChartConfig,
    rsiData: List<LineData> = emptyList(),
    macdData: MACDResult? = null,
    bollingerBands: BollingerBandsResult? = null,
    showRSI: Boolean = false,
    showMACD: Boolean = false,
    showVolume: Boolean = true,
    showBollingerBands: Boolean = false,
    modifier: Modifier = Modifier
) {
    val context = LocalContext.current
    
    // Ï∞®Ìä∏ HTML ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
    val chartHtml = remember(candlestickData, volumeData, showRSI, showMACD, showVolume, showBollingerBands) {
        generateChartHtml(
            candlestickData, volumeData, sma5Data, sma20Data,
            rsiData, macdData, bollingerBands,
            showRSI, showMACD, showVolume, showBollingerBands
        )
    }
    
    AndroidView(
        factory = { context ->
            WebView(context).apply {
                // WebView ÏÑ§Ï†ï - TradingView Î™®Î∞îÏùº ÏµúÏ†ÅÌôî
                settings.apply {
                    // Í∏∞Î≥∏ JavaScript ÏÑ§Ï†ï
                    javaScriptEnabled = true
                    domStorageEnabled = true
                    
                    // ÌååÏùº Ï†ëÍ∑º Í∂åÌïú
                    allowFileAccess = true
                    allowContentAccess = true
                    allowUniversalAccessFromFileURLs = true
                    allowFileAccessFromFileURLs = true
                    
                    // Î™®Î∞îÏùº ÏµúÏ†ÅÌôî ÏÑ§Ï†ï
                    setSupportZoom(true) // TradingViewÎäî Ï§å ÏßÄÏõê ÌïÑÏöî
                    builtInZoomControls = true
                    displayZoomControls = false // Ïª®Ìä∏Î°§ÏùÄ Ïà®ÍπÄ
                    loadWithOverviewMode = true
                    useWideViewPort = true
                    
                    // Î≥¥Ïïà ÏÑ§Ï†ï
                    mixedContentMode = android.webkit.WebSettings.MIXED_CONTENT_ALWAYS_ALLOW
                    
                    // ÏÑ±Îä• ÏµúÏ†ÅÌôî
                    cacheMode = android.webkit.WebSettings.LOAD_DEFAULT
                    
                    // Î™®Î∞îÏùº ÌäπÌôî ÏÑ§Ï†ï
                    textZoom = 100
                    minimumFontSize = 8
                    
                    // JavaScript ÎîîÎ≤ÑÍπÖ Í∞ïÌôî
                    mediaPlaybackRequiresUserGesture = false
                }
                
                // ÎîîÎ≤ÑÍπÖ ÌôúÏÑ±Ìôî
                if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.KITKAT) {
                    WebView.setWebContentsDebuggingEnabled(true)
                }
                
                webViewClient = object : WebViewClient() {
                    override fun onReceivedError(
                        view: WebView?,
                        errorCode: Int,
                        description: String?,
                        failingUrl: String?
                    ) {
                        super.onReceivedError(view, errorCode, description, failingUrl)
                        android.util.Log.e("ChartWebView", "WebView Error: $description at $failingUrl")
                    }
                }
                
                webChromeClient = object : WebChromeClient() {
                    override fun onConsoleMessage(consoleMessage: android.webkit.ConsoleMessage?): Boolean {
                        consoleMessage?.let {
                            val level = when (it.messageLevel()) {
                                android.webkit.ConsoleMessage.MessageLevel.ERROR -> "ERROR"
                                android.webkit.ConsoleMessage.MessageLevel.WARNING -> "WARNING"  
                                android.webkit.ConsoleMessage.MessageLevel.DEBUG -> "DEBUG"
                                else -> "LOG"
                            }
                            android.util.Log.d("ChartConsole", "[$level] ${it.message()} at ${it.sourceId()}:${it.lineNumber()}")
                        }
                        return true
                    }
                }
                
                // HTML Î°úÎìú
                loadDataWithBaseURL(
                    "file:///android_asset/",
                    chartHtml,
                    "text/html",
                    "UTF-8",
                    null
                )
            }
        },
        update = { webView ->
            // Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            val updateJs = generateUpdateScript(
                candlestickData, volumeData, sma5Data, sma20Data,
                rsiData, macdData, bollingerBands,
                showRSI, showMACD, showVolume, showBollingerBands
            )
            webView.evaluateJavascript(updateJs, null)
        },
        modifier = modifier.fillMaxSize()
    )
}

private fun generateChartHtml(
    candlestickData: List<CandlestickData>,
    volumeData: List<VolumeData>,
    sma5Data: List<LineData>,
    sma20Data: List<LineData>,
    rsiData: List<LineData>,
    macdData: MACDResult?,
    bollingerBands: BollingerBandsResult?,
    showRSI: Boolean,
    showMACD: Boolean,
    showVolume: Boolean,
    showBollingerBands: Boolean
): String {
    return """
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightweight Charts v5</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: #000000; 
            overflow: hidden;
        }
        #chart { 
            width: 100vw; 
            height: 100vh; 
            position: absolute;
            top: 0;
            left: 0;
            background: #000000;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    
    <!-- v5.0.8 UMD Î≤àÎì§ Î°úÎìú -->
    <script src="file:///android_asset/com/tradingview/lightweightcharts/scripts/v5/lightweight-charts-v5.bundle.js"></script>
    
    <script>
        console.log("=== UMD v5.0.8 BUNDLE APPROACH ===");
        
        // 5Ï¥à ÌõÑÏóêÎèÑ Ï∞®Ìä∏Í∞Ä ÏóÜÏúºÎ©¥ fallback Ïã§Ìñâ
        setTimeout(() => {
            if (!window.chart || !document.querySelector('canvas')) {
                console.log("‚ö†Ô∏è No chart detected after 5s, creating fallback display");
                const container = document.getElementById('chart');
                if (container) {
                    container.style.background = '#000000';
                    container.style.color = '#FFFFFF';
                    container.style.display = 'flex';
                    container.style.alignItems = 'center';
                    container.style.justifyContent = 'center';
                    container.style.fontSize = '18px';
                    container.innerHTML = 'üìä Chart Loading... (UMD v5.0.8)';
                    console.log("‚úÖ Fallback display created");
                }
            }
        }, 5000);
        
        // UMD Î∞©ÏãùÏúºÎ°ú v5 Ï∞®Ìä∏ ÏÉùÏÑ± - WebView ÏïàÏ†ïÏÑ±ÏùÑ ÏúÑÌïú ÏßÄÏó∞ Ï¥àÍ∏∞Ìôî
        function initUMDChart() {
            const container = document.getElementById('chart');
            
            if (!container) {
                console.error('‚ùå Chart container not found!');
                return;
            }
            
            console.log("=== UMD Chart Initialization ===");
            console.log("Container found:", !!container);
            console.log("Container dimensions:", container.clientWidth, "x", container.clientHeight);
            
            // UMD Î≤àÎì§ÏóêÏÑú LightweightChartsV5 ÏÇ¨Ïö©
            console.log("LightweightChartsV5 available:", !!window.LightweightChartsV5);
            console.log("createChart function:", typeof window.LightweightChartsV5?.createChart);
            
            if (!window.LightweightChartsV5 || !window.LightweightChartsV5.createChart) {
                console.error("‚ùå LightweightChartsV5 not available from UMD bundle");
                return;
            }
            
            // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ ÌôïÏù∏ Î∞è ÎåÄÍ∏∞
            function waitForValidContainer(callback, attempts = 0) {
                const maxAttempts = 20; // ÏµúÎåÄ 2Ï¥à ÎåÄÍ∏∞
                
                if (attempts >= maxAttempts) {
                    console.error("‚ùå Container size validation failed after", maxAttempts, "attempts");
                    return;
                }
                
                const width = container.clientWidth || window.innerWidth;
                const height = container.clientHeight || window.innerHeight;
                
                console.log("üìè Container check " + (attempts + 1) + ": " + width + " x " + height);
                
                if (width > 0 && height > 0) {
                    console.log("‚úÖ Valid container size detected, proceeding with chart creation");
                    callback(width, height);
                } else {
                    console.log("‚è≥ Container not ready, retrying in 100ms...");
                    setTimeout(() => waitForValidContainer(callback, attempts + 1), 100);
                }
            }
            
            // WebView ÏïàÏ†ïÏÑ±ÏùÑ ÏúÑÌïú ÏßÄÏó∞ Ïã§Ìñâ
            setTimeout(() => {
                waitForValidContainer((width, height) => {
                    try {
                        console.log("‚è∞ Starting chart creation with valid dimensions:", width, "x", height);
                        
                        // v5.0.8 createChart ÏÇ¨Ïö© - Î™ÖÏãúÏ†Å ÌÅ¨Í∏∞ ÏßÄÏ†ï
                        const chart = window.LightweightChartsV5.createChart(container, {
                            width: width,
                            height: height,
                            layout: {
                                background: { color: '#000000' },
                                textColor: '#ffffff'
                            },
                            grid: {
                                vertLines: { color: '#333' },
                                horzLines: { color: '#333' }
                            }
                        });
                    
                    console.log("‚úÖ UMD Chart created successfully!");
                    
                    // Ï∞®Ìä∏ ÏÉùÏÑ± ÌõÑ Ï∂îÍ∞Ä ÏßÄÏó∞ÏúºÎ°ú ÏãúÎ¶¨Ï¶à Ï∂îÍ∞Ä
                    requestAnimationFrame(() => {
                        try {
                            console.log("üîç Debugging addSeries call...");
                            console.log("Chart object:", chart);
                            console.log("Chart methods:", Object.getOwnPropertyNames(Object.getPrototypeOf(chart)));
                            console.log("addSeries function:", typeof chart.addSeries);
                            
                            // v5.0.8 addSeries Ìò∏Ï∂ú Î∞©Ïãù ÌÖåÏä§Ìä∏
                            console.log("Attempting addSeries with 'Candlestick'...");
                            
                            // v5 addSeries Îã§ÏñëÌïú Î∞©Ïãù ÏãúÎèÑ
                            let candlestickSeries = null;
                            
                            // Î∞©Î≤ï 1: Î¨∏ÏûêÏó¥ ÌÉÄÏûÖ
                            try {
                                console.log("üî∏ Trying method 1: addSeries('Candlestick', options)");
                                candlestickSeries = chart.addSeries('Candlestick', {
                                    upColor: '#26a69a',
                                    downColor: '#ef5350',
                                    wickUpColor: '#26a69a',
                                    wickDownColor: '#ef5350'
                                });
                                console.log("‚úÖ Method 1 success!");
                            } catch (e1) {
                                console.log("‚ùå Method 1 failed:", e1.message);
                                
                                // Î∞©Î≤ï 2: ÏÜåÎ¨∏Ïûê
                                try {
                                    console.log("üî∏ Trying method 2: addSeries('candlestick', options)");
                                    candlestickSeries = chart.addSeries('candlestick', {
                                        upColor: '#26a69a',
                                        downColor: '#ef5350',
                                        wickUpColor: '#26a69a',
                                        wickDownColor: '#ef5350'
                                    });
                                    console.log("‚úÖ Method 2 success!");
                                } catch (e2) {
                                    console.log("‚ùå Method 2 failed:", e2.message);
                                    
                                    // Î∞©Î≤ï 3: SeriesType enum Î∞©Ïãù
                                    try {
                                        console.log("üî∏ Trying method 3: chart.addSeries with SeriesType");
                                        candlestickSeries = chart.addSeries({
                                            type: 'Candlestick',
                                            upColor: '#26a69a',
                                            downColor: '#ef5350',
                                            wickUpColor: '#26a69a',
                                            wickDownColor: '#ef5350'
                                        });
                                        console.log("‚úÖ Method 3 success!");
                                    } catch (e3) {
                                        console.log("‚ùå Method 3 failed:", e3.message);
                                        
                                        // Î∞©Î≤ï 4: Í∏∞Î≥∏ ÏòµÏÖòÎßå
                                        try {
                                            console.log("üî∏ Trying method 4: minimal options");
                                            candlestickSeries = chart.addSeries('Candlestick');
                                            console.log("‚úÖ Method 4 success!");
                                        } catch (e4) {
                                            console.log("‚ùå All methods failed!");
                                            throw e4;
                                        }
                                    }
                                }
                            }
                            
                            console.log("‚úÖ UMD Candlestick series created!");
                            
                            // v5 Ìò∏Ìôò candlestick Îç∞Ïù¥ÌÑ∞ - UNIX timestamp ÏÇ¨Ïö©
                            const candlestickData = [
                                { time: 1704067200, open: 75000, high: 76000, low: 74500, close: 75800 }, // 2024-01-01
                                { time: 1704153600, open: 75800, high: 77000, low: 75200, close: 76500 }, // 2024-01-02
                                { time: 1704240000, open: 76500, high: 77500, low: 76000, close: 77200 }, // 2024-01-03
                                { time: 1704326400, open: 77200, high: 78000, low: 76800, close: 77800 }, // 2024-01-04
                                { time: 1704412800, open: 77800, high: 78500, low: 77400, close: 78200 }, // 2024-01-05
                                { time: 1704672000, open: 78200, high: 79000, low: 77800, close: 78900 }, // 2024-01-08 (Ï£ºÎßê Ï†úÏô∏)
                                { time: 1704758400, open: 78900, high: 79500, low: 78500, close: 79200 }, // 2024-01-09
                                { time: 1704844800, open: 79200, high: 80000, low: 78800, close: 79600 }  // 2024-01-10
                            ];
                            
                            console.log("üìä Data validation:");
                            console.log("- Data length:", candlestickData.length);
                            console.log("- Time format: UNIX timestamp");
                            console.log("- Order: ASC (ascending)");
                            console.log("- No null values: ‚úÖ");
                            console.log("- No duplicate times: ‚úÖ");
                            
                            if (candlestickSeries) {
                                candlestickSeries.setData(candlestickData);
                                console.log("‚úÖ UMD Candlestick data set successfully!");
                            } else {
                                console.log("‚ùå No series available for data setting");
                            }
                            
                            // Ï†ÑÏó≠ÏúºÎ°ú Ï∞®Ìä∏ ÎÖ∏Ï∂ú
                            window.chart = chart;
                            window.candlestickSeries = candlestickSeries;
                            
                            console.log("üéâ UMD v5.0.8 SUCCESS! Chart is working!");
                            
                            // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§Îü¨
                            window.addEventListener('resize', () => {
                                chart.applyOptions({
                                    width: window.innerWidth,
                                    height: window.innerHeight
                                });
                            });
                            
                        } catch (seriesError) {
                            console.error("‚ùå Series creation failed:", seriesError);
                            console.error("Series error stack:", seriesError.stack);
                            
                            // fallback: v4 Î∞©Ïãù ÏãúÎèÑ
                            console.log("üîÑ Trying v4 fallback...");
                            try {
                                if (typeof chart.addCandlestickSeries === 'function') {
                                    console.log("v4 addCandlestickSeries available, using fallback");
                                    const fallbackSeries = chart.addCandlestickSeries({
                                        upColor: '#26a69a',
                                        downColor: '#ef5350',
                                        wickUpColor: '#26a69a',
                                        wickDownColor: '#ef5350'
                                    });
                                    window.candlestickSeries = fallbackSeries;
                                    console.log("‚úÖ v4 fallback series created!");
                                } else {
                                    console.log("‚ùå No v4 fallback available");
                                }
                            } catch (fallbackError) {
                                console.error("‚ùå v4 fallback also failed:", fallbackError);
                            }
                        }
                    });
                    
                    } catch (chartError) {
                        console.error("‚ùå UMD Chart creation failed:", chartError);
                        console.error("Chart error stack:", chartError.stack);
                    }
                });
            }, 150);  // 150ms ÏßÄÏó∞ÏúºÎ°ú WebView ÏïàÏ†ïÌôî ÎåÄÍ∏∞
        }
        
        // ÏïàÏ†ïÏ†ÅÏù∏ Ï¥àÍ∏∞ÌôîÎ•º ÏúÑÌïú Îã§Ï§ë Ï≤¥ÌÅ¨
        function safeInitChart() {
            if (document.readyState === 'complete') {
                // Î¨∏ÏÑú ÏôÑÏ†Ñ Î°úÎìúÎê®
                requestAnimationFrame(initUMDChart);
            } else {
                // ÏïÑÏßÅ Î°úÎî© Ï§ë
                window.addEventListener('load', () => {
                    requestAnimationFrame(initUMDChart);
                });
            }
        }
        
        // DOM Ï§ÄÎπÑ ÏÉÅÌÉúÏóê Îî∞Î•∏ Ï¥àÍ∏∞Ìôî
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInitChart);
        } else {
            safeInitChart();
        }
    </script>
</body>
</html>
    """.trimIndent()
}

private fun generateUpdateScript(
    candlestickData: List<CandlestickData>,
    volumeData: List<VolumeData>,
    sma5Data: List<LineData>,
    sma20Data: List<LineData>,
    rsiData: List<LineData>,
    macdData: MACDResult?,
    bollingerBands: BollingerBandsResult?,
    showRSI: Boolean,
    showMACD: Boolean,
    showVolume: Boolean,
    showBollingerBands: Boolean
): String {
    return """
        console.log("‚úÖ Pure v5 chart data update requested");
        if (window.chart && window.LightweightCharts) {
            console.log("‚úÖ Chart available for update");
            // Pure v5 Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅÏùÄ Ïó¨Í∏∞Ïóê Íµ¨ÌòÑ
        } else {
            console.log("‚ùå Chart not available for update");
        }
    """.trimIndent()
}